// app/orderConfirmation.tsx
import React, { useState, useEffect } from "react";
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  ScrollView,
  Alert,
} from "react-native";
import { useRouter, useLocalSearchParams } from "expo-router";
import { useResponsiveValues } from "../lib/responsive";
import { handleAccountNavigation } from "../lib/authUtils";
import { orderService, OrderData } from "../lib/orderService";
import { supabase } from "../lib/supabase";

export default function OrderConfirmation() {
  const router = useRouter();
  const responsive = useResponsiveValues();
  const [orderCreated, setOrderCreated] = useState(false);
  const [orderId, setOrderId] = useState<number | null>(null);
  const [loading, setLoading] = useState(true);
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  
  // Get order data from navigation params
  const params = useLocalSearchParams();
  const name = Array.isArray(params.name) ? params.name[0] : params.name || "Member";
  const pizza = Array.isArray(params.pizza) ? params.pizza[0] : params.pizza || "Pizza";
  const time = Array.isArray(params.time) ? params.time[0] : params.time || "6:00 PM";
  const date = Array.isArray(params.date) ? params.date[0] : params.date || new Date().toLocaleDateString();
  const phone = Array.isArray(params.phone) ? params.phone[0] : params.phone || "555-123-4567";
  const username = Array.isArray(params.username) ? params.username[0] : params.username;
  const timeSlotId = Array.isArray(params.timeSlotId) ? params.timeSlotId[0] : params.timeSlotId;

  // Extract pizza price from pizza name (basic parsing)
  const pizzaPrice = pizza.includes('Margherita') ? 18.99 : 
                    pizza.includes('Pepperoni') ? 19.99 : 
                    pizza.includes('Hawaiian') ? 21.99 : 18.99;

  useEffect(() => {
    createOrder();
  }, []);

  const createOrder = async () => {
    try {
      setLoading(true);
      
      console.log('üîç Starting order creation...', { username, name, pizza, phone, timeSlotId });
      
      // Look up member by username to get actual member_id and phone
      let memberId: string | number = "";
      let memberPhone: string = phone;
      
      if (username) {
        console.log('üîç Looking up member by username:', username);
        const { data: member, error: memberError } = await supabase
          .from('members')
          .select('id, phone')
          .eq('username', username)
          .single();
        
        if (!memberError && member) {
          memberId = member.id;
          memberPhone = member.phone || phone;
          console.log('‚úÖ Found member:', { memberId, memberPhone, memberIdType: typeof memberId });
      } else {
        const errorMsg = `Could not find your member account. Error: ${memberError?.message || 'Unknown error'}`;
        console.error('‚ùå Member lookup failed:', memberError);
        setErrorMessage(errorMsg);
        setLoading(false);
        return;
      }
    } else {
      const errorMsg = 'You must be logged in to place an order. Please log in and try again.';
      console.error('‚ùå No username provided - cannot create order');
      setErrorMessage(errorMsg);
      setLoading(false);
      return;
    }
    
    // Validate we have required member data
    if (!memberId || !memberPhone || memberPhone === "555-123-4567") {
      const errorMsg = `Missing member information. Member ID: ${memberId ? 'found' : 'missing'}, Phone: ${memberPhone || 'missing'}`;
      console.error('‚ùå Invalid member data:', { memberId, memberPhone });
      setErrorMessage(errorMsg);
      setLoading(false);
      return;
    }

    // Validate we have time slot ID
    if (!timeSlotId) {
      const errorMsg = 'Time slot ID is missing. Please go back to the menu and select a time slot.';
      console.error('‚ùå No timeSlotId provided');
      setErrorMessage(errorMsg);
      setLoading(false);
      return;
    }
      
      const orderData: OrderData = {
        member_id: String(memberId),
        pizza_name: pizza,
        pizza_price: pizzaPrice,
        time_slot: time,
        time_slot_id: timeSlotId, // NEW: Pass the time slot ID directly
        date: date,
        phone: memberPhone,
        special_instructions: `Order for ${name}`
      };

      console.log('üçï Creating order with data:', orderData);
      
      const result = await orderService.createOrder(orderData);
      
      console.log('üìã Order service result:', result);
      
      if (result.success && result.orderId) {
        setOrderCreated(true);
        setOrderId(result.orderId);
        setErrorMessage(null);
        console.log('‚úÖ Order created successfully:', result.orderId);
      } else {
        const errorMsg = result.error || 'Failed to create order';
        console.error('‚ùå Order creation failed:', result.error);
        console.error('Full error details:', { result, orderData });
        setErrorMessage(errorMsg);
      }
    } catch (error: any) {
      const errorMsg = error?.message || 'Failed to create order';
      console.error('‚ùå Order creation error:', error);
      setErrorMessage(errorMsg);
    } finally {
      setLoading(false);
    }
  };

  const styles = createStyles(responsive);

  if (loading) {
    return (
      <ScrollView style={styles.container} contentContainerStyle={styles.contentContainer}>
        <Text style={styles.message}>üîÑ Creating your order...</Text>
        <Text style={styles.loadingText}>Please wait while we process your order and send confirmation.</Text>
      </ScrollView>
    );
  }

  return (
    <ScrollView style={styles.container} contentContainerStyle={styles.contentContainer}>
      {/* Message at top */}
      <Text style={styles.message}>
        {orderCreated ? '‚úÖ Your order has been placed!' : '‚ùå Order failed to process'}
      </Text>
      
      {/* Error message display */}
      {errorMessage && (
        <View style={styles.errorBox}>
          <Text style={styles.errorText}>ERROR:</Text>
          <Text style={styles.errorDetails}>{errorMessage}</Text>
        </View>
      )}

      {orderCreated && orderId && (
        <View style={styles.orderIdCard}>
          <Text style={styles.orderIdText}>Order #{orderId}</Text>
        </View>
      )}

      {/* Order Details Card */}
      <View style={styles.orderCard}>
        <Text style={styles.cardTitle}>ORDER CONFIRMATION</Text>
        
        <View style={styles.detailRow}>
          <Text style={styles.detailLabel}>Full Name:</Text>
          <Text style={styles.detailValue}>{name}</Text>
        </View>
        
        <View style={styles.detailRow}>
          <Text style={styles.detailLabel}>Order:</Text>
          <Text style={styles.detailValue}>{pizza}</Text>
        </View>
        
        <View style={styles.detailRow}>
          <Text style={styles.detailLabel}>Price:</Text>
          <Text style={styles.detailValue}>${pizzaPrice}</Text>
        </View>
        
        <View style={styles.detailRow}>
          <Text style={styles.detailLabel}>Pickup Time:</Text>
          <Text style={styles.detailValue}>{time}</Text>
        </View>
        
        <View style={styles.detailRow}>
          <Text style={styles.detailLabel}>Date:</Text>
          <Text style={styles.detailValue}>{date}</Text>
        </View>
        
        <View style={styles.detailRow}>
          <Text style={styles.detailLabel}>Pickup:</Text>
          <Text style={styles.detailValue}>349 Eagle Dr (Hot Box by mailbox)</Text>
        </View>
        
        {orderCreated && (
          <View style={styles.smsNotification}>
            <Text style={styles.smsText}>üì± SMS confirmation sent to {phone}</Text>
          </View>
        )}
      </View>

      {/* Menu buttons */}
      <View style={styles.menuBox}>
        <View style={styles.buttonRow}>
          <TouchableOpacity
            style={styles.menuButton}
            onPress={() => handleAccountNavigation(router, username)}
          >
            <Text style={styles.menuText}>Account</Text>
          </TouchableOpacity>

          <TouchableOpacity
            style={styles.menuButton}
            onPress={() => router.push({ pathname: "/history", params: username ? { username } : undefined })}
          >
            <Text style={styles.menuText}>History</Text>
          </TouchableOpacity>
        </View>
        
        <View style={styles.buttonRow}>
          <TouchableOpacity
            style={styles.menuButton}
            onPress={() => router.push({ pathname: "/contact", params: username ? { username } : undefined })}
          >
            <Text style={styles.menuText}>Contact</Text>
          </TouchableOpacity>

          <TouchableOpacity
            style={styles.menuButton}
            onPress={() => router.push({ pathname: "/about", params: username ? { username } : undefined })}
          >
            <Text style={styles.menuText}>About</Text>
          </TouchableOpacity>
        </View>
      </View>
    </ScrollView>
  );
}

const createStyles = (responsive: any) => StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: "black",
  },
  contentContainer: {
    flexGrow: 1,
    alignItems: "center",
    justifyContent: "flex-start",
    paddingTop: responsive.padding.xl,
    paddingHorizontal: responsive.padding.lg,
    paddingBottom: responsive.padding.xl,
  },
  message: {
    fontSize: responsive.fontSize.xxxl,
    color: "#00FF66",
    fontFamily: "VT323_400Regular",
    marginBottom: responsive.margin.lg,
    textAlign: "center",
  },
  loadingText: {
    fontSize: responsive.fontSize.lg,
    color: "#00FF66",
    fontFamily: "VT323_400Regular",
    textAlign: "center",
    opacity: 0.8,
  },
  orderIdCard: {
    backgroundColor: "#001a00",
    borderWidth: 2,
    borderColor: "#00FF66",
    padding: 12,
    marginBottom: responsive.margin.md,
    borderRadius: 4,
  },
  orderIdText: {
    fontSize: responsive.fontSize.xl,
    color: "#00FF66",
    fontFamily: "VT323_400Regular",
    textAlign: "center",
    fontWeight: "bold",
  },
  errorBox: {
    backgroundColor: "#1a0000",
    borderWidth: 2,
    borderColor: "#ff6666",
    padding: 16,
    marginBottom: responsive.margin.md,
    borderRadius: 4,
    width: "100%",
    maxWidth: responsive.isMobile ? 320 : responsive.isTablet ? 400 : 450,
  },
  errorText: {
    fontSize: responsive.fontSize.lg,
    color: "#ff6666",
    fontFamily: "VT323_400Regular",
    fontWeight: "bold",
    marginBottom: 8,
    textShadowColor: "#ff0000",
    textShadowOffset: { width: 0, height: 0 },
    textShadowRadius: 8,
  },
  errorDetails: {
    fontSize: responsive.fontSize.md,
    color: "#ff9999",
    fontFamily: "VT323_400Regular",
    lineHeight: 20,
  },
  orderCard: {
    width: "100%",
    maxWidth: responsive.isMobile ? 320 : responsive.isTablet ? 400 : 450,
    borderWidth: 2,
    borderColor: "#00FF66",
    backgroundColor: "black",
    padding: 16,
    marginBottom: responsive.margin.lg,
    shadowColor: "#00FF66",
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.3,
    shadowRadius: 4,
    elevation: 4,
  },
  cardTitle: {
    fontSize: responsive.fontSize.lg,
    color: "#00FF66",
    fontFamily: "VT323_400Regular",
    textAlign: "center",
    marginBottom: 12,
    textShadowColor: "#00aa44",
    textShadowOffset: { width: 0, height: 0 },
    textShadowRadius: 4,
  },
  detailRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
    marginBottom: 8,
    paddingVertical: 4,
  },
  detailLabel: {
    fontSize: responsive.fontSize.lg,
    color: "#00FF66",
    fontFamily: "VT323_400Regular",
    flex: 1,
  },
  detailValue: {
    fontSize: responsive.fontSize.lg,
    color: "#00FF66",
    fontFamily: "VT323_400Regular",
    flex: 2,
    textAlign: "right",
  },
  smsNotification: {
    marginTop: 12,
    padding: 8,
    backgroundColor: "#001a00",
    borderRadius: 4,
    borderWidth: 1,
    borderColor: "#00aa44",
  },
  smsText: {
    fontSize: responsive.fontSize.md,
    color: "#00FF66",
    fontFamily: "VT323_400Regular",
    textAlign: "center",
  },
  menuBox: {
    width: "100%",
    maxWidth: responsive.isMobile ? 320 : responsive.isTablet ? 400 : 450,
    alignItems: "center",
  },
  buttonRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    width: "100%",
    marginBottom: responsive.margin.sm,
    gap: responsive.margin.sm,
  },
  menuButton: {
    borderWidth: 2,
    borderColor: "#00FF66",
    paddingVertical: responsive.padding.sm,
    paddingHorizontal: responsive.padding.md,
    flex: 1,
    alignItems: "center",
    backgroundColor: "black",
    minHeight: 40,
    justifyContent: "center",
  },
  menuText: {
    fontSize: responsive.isMobile ? responsive.fontSize.md : responsive.fontSize.lg,
    color: "#00FF66",
    fontFamily: "VT323_400Regular",
    textAlign: "center",
  },
});

